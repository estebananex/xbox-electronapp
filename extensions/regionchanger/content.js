(()=>{"use strict";function e(e,...t){console.log(`[xbox-cloud-server-selector] ${e}`,...t)}class t{requestPattern={method:"GET",urlPattern:new URLPattern("https://*.core.gssv-play-prod.xboxlive.com/v5/sessions/cloud/*/ice")};getIpVersion(e){return/(\d+\.){3}\d+/.test(e)?"ipv4":"ipv6"}async intercept(t,n){if(!t.ipVersion||"default"==t.ipVersion.value)return n;const s=await n.json(),r=JSON.parse(s.exchangeResponse);e("Found ICE candidates:",r);const o=r.filter((e=>{const n=new RTCIceCandidate(e);return!n.address||this.getIpVersion(n.address)==t.ipVersion.value}));return e("New ICE candidates:",o),s.exchangeResponse=JSON.stringify(o),new Response(JSON.stringify(s),n)}}class n{requestPattern={method:"POST",urlPattern:new URLPattern("https://xgpuweb(f2p)?.gssv-play-prod.xboxlive.com/v2/login/user")};async intercept(t,n){if(!t.region||"default"==t.region.value)return n;const s=await n.json();e("Found regions:",s.offeringSettings.regions);const r=[{name:t.region.text,baseUri:`https://${t.region.value}.core.gssv-play-prod.xboxlive.com`,networkTestHostname:`https://${t.region.value}.gssv-fastlane-prod.xboxlive.com`,isDefault:!0,systemUpdateGroups:null,fallbackPriority:-1}];return e("New regions:",r),s.offeringSettings.regions=r,new Response(JSON.stringify(s),n)}}window.addEventListener("message",(s=>{"xbox-cloud-server-selector"==s.data.from&&function(s){e("Received settings:",s);const{fetch:r}=window;window.fetch=async(...o)=>{const[i,a]=o,c=await r(i,a),l=[new n,new t];for(const t of l)if(i instanceof Request&&i.method==t.requestPattern.method&&t.requestPattern.urlPattern.test(i.url))return e(`Intercepted call to ${i.url}`),await t.intercept(s,c);return c}}(s.data.settings)})),e("Settings listener alive")})();